<div st-table="$ctrl.displayed" st-safe-src="$ctrl.results" st-set-filter="customFilter" chpl-table-state-listener="$ctrl.tableStateListener(tableController)">
  <div class="row">
    <div class="col-sm-12">
      <h3>Announcements</h3>
    </div>
  </div>
  <div class="row">
    <div class="col-sm-6">
      <chpl-saved-filter filter-type-name="Announcement Report" on-apply-filter="$ctrl.onApplyFilter(filter)"
                         get-filter-data="$ctrl.createFilterDataObject()" on-clear-filter="$ctrl.onClearFilter()"></chpl-saved-filter>
    </div>
    <div class="col-sm-6" ng-if="$ctrl.displayed.length > 0">
      <button class="btn btn-ai-success pull-right" ng-click="$ctrl.prepareDownload()" ng-if="!$ctrl.ReportService.downloadReady($ctrl.displayed) && $ctrl.canDownload()"><i class="fa fa-bolt"></i> Prepare download</button>
      <button class="btn btn-ai-success pull-right" disabled ng-if="!$ctrl.canDownload()"><i class="fa fa-ban"></i> Too many results to download</button>
      <button class="btn btn-ai-success pull-right" ng-if="$ctrl.ReportService.downloadReady($ctrl.displayed)"
              ng-csv="$ctrl.displayed" filename="Announcement_{{ $ctrl.filename }}" quote-strings="true" add-bom="true"
              csv-header="['Description', 'Responsible User', 'Activity', 'Activity Date']"
              csv-column-order="['description', 'responsibleUserFullName', 'action', 'friendlyActivityDate']">
          <i class="fa fa-cloud-download"></i> Download</button>
        <br />
        <div ng-if="$ctrl.downloadProgress.complete < 100 && $ctrl.downloadProgress.complete > 0">
          Progress:<br />
          <uib-progressbar max="100" value="$ctrl.downloadProgress.complete" type="success" title="{{ $ctrl.downloadProgress.complete }}% prepared">
            {{ $ctrl.downloadProgress.complete }}% prepared
          </uib-progressbar>
        </div>
    </div>
  </div>
  <div class="row form-group">
    <div class="col-sm-5">
      <label for="data-filter" class="control-label">Filter</label>
      <input chpl-search="filterText" ng-model="$ctrl.filterText" name="dataFilter" id="data-filter" placeholder="Filter on description or responsible user" class="form-control" type="search">
    </div>
  </div>
  <div class="row">
    <div class="col-sm-5">
      Filter on Activity Date
      <chpl-date-range
        predicate="date"
        register-clear-filter="$ctrl.registerClearFilter(clearFilter)"
        register-restore-state="$ctrl.registerRestoreState(restoreState)"
        ></chpl-date-range>
    </div>
  </div>
  <div class="row" ng-if="$ctrl.showLoadingBar()">
    <div class="col-sm-5">
      Progress:<br />
      <uib-progressbar max="100" value="$ctrl.loadProgress.percentage" type="success" title="{{ $ctrl.loadProgress.percentage }}% complete loading">
        {{ $ctrl.loadProgress.percentage }}% complete loading
      </uib-progressbar>
    </div>
  </div>
  <div class="row">
    <div class="col-sm-12">
      <table class="table table-responsive">
        <thead>
          <tr>
            <td colspan="3" class="text-center">
              <div st-pagination="" st-items-by-page="$ctrl.pageSize" st-displayed-pages="10"></div>
            </td>
          </tr>
          <tr>
            <th class="search-header" st-sort="description" st-skip-natural="true">Description</th>
            <th class="search-header" st-sort="responsibleUserFullName" st-skip-natural="true">Responsible User</th>
            <th class="search-header" st-sort="date" st-skip-natural="true" st-sort-default="reverse">Activity Date</th>
          </tr>
        </thead>
        <tfoot>
          <tr>
            <td colspan="4" class="text-center">
              <div class="text-right">
                <label for="pageSizeTop" class="sr-only">Show how many results</label>
                Showing up to&nbsp;
                <select ng-model="$ctrl.pageSize" id="pageSizeTop"
                        ng-options="v as v for v in [50,100,250,1000,5000]">
                </select>
                &nbsp;results per page
              </div>
              <div st-pagination="" st-items-by-page="$ctrl.pageSize" st-displayed-pages="10"></div>
            </td>
          </tr>
        </tfoot>
        <tbody>
          <tr ng-repeat="activity in $ctrl.displayed">
            <td>{{ activity.description }}</td>
            <td>{{ activity.responsibleUserFullName }}</td>
            <td>
              <button class="btn btn-link pull-right" ng-if="!activity.action && !activity.showDetails"
                      ng-click="$ctrl.parse(activity); activity.showDetails = true">Details</button>
              <button class="btn btn-link pull-right" ng-if="activity.action && !activity.showDetails"
                      ng-click="activity.showDetails = true">Details</button>
              <button class="btn btn-link pull-right" ng-if="activity.action && activity.showDetails"
                      ng-click="activity.showDetails = false">Hide Details</button>
              <button class="btn btn-link pull-right" ng-if="!activity.action && activity.showDetails" disabled><i class="fa fa-spin fa-spinner"></i> Processing</button>
              {{ activity.date | date : 'MMM d, y H:mm:ss Z' : 'UTC' }}
              <div ng-if="activity.action && activity.showDetails" ng-bind-html="activity.action">
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
